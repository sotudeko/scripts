import groovy.json.JsonOutput
import groovy.json.JsonSlurper

class PolicyViolations {
    static void main(String[] args){

        def repositoryUrl = args[0]
        def policyId = args[1]

        def endpoint = repositoryUrl + '/api/v2/policyViolations'
        def query = '?p=' + policyId
        def repoAddress = endpoint + query

        def url = new URL(repoAddress)
        def violationsConnection = url.openConnection()

        violationsConnection.requestMethod = 'GET'
        violationsConnection.setRequestProperty("Authorization", "Basic YWRtaW46YWRtaW4xMjM=")

        if (violationsConnection.responseCode == 200) {
            def violationsContent = violationsConnection.content.text

            def jsonSlurper = new JsonSlurper()
            def violationsJsonObject = jsonSlurper.parseText(violationsContent)

            violationsJsonObject.applicationViolations.each {

                String currentApplicationName = it.application.name

                println ''
                println 'Application: ' + currentApplicationName
                println JsonOutput.prettyPrint(JsonOutput.toJson(it))
            }
        }
    }
}
